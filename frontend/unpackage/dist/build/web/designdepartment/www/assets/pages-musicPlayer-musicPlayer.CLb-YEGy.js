import{y as e,c as t,j as o,$ as n,g as s,s as l,u as a,z as r,A as i,B as c,C as u,r as d,o as g,D as p,E as y,G as f,b as v,w as h,i as _,d as m,e as w,f as k,t as P,p as x,q as b,F as C,m as I,H as T,J as A,a as L,k as S,l as $,K as M,S as E,h as U,L as H}from"./index-2gCYdGq0.js";import{u as R}from"./userAuth.Bhpsn2CI.js";import{_ as j,g as z,a as V,u as W}from"./_plugin-vue_export-helper.BGUu7VIo.js";const B=e({playlist:[],currentIndex:0,isPlaying:!1,isPaused:!1,currentTime:0,duration:0,volume:.8,playMode:"list",audioContext:null,backgroundAudioManager:null,hasErrorShown:!1,isLoadingAudio:!1});let F=null;const N=e({enabled:!1,wakeLock:null,audioContext:null,keepAliveTimer:null,networkTimer:null,isPageVisible:!0});const D=j({__name:"musicPlayer",setup(j){const{logout:D,currentUser:O,getStoredAuth:Z}=R(),{connectionState:J,connect:X,disconnect:G,getPlaylist:K}=W(),{playerState:q,initAudioManager:Q,playMusic:Y,pauseMusic:ee,resumeMusic:te,stopMusic:oe,playNext:ne,playPrevious:se,setVolume:le,setProgress:ae,debugServerConfig:re,clearServerConfig:ie}=function(){const e=t((()=>B.playlist[B.currentIndex]||null)),i=t((()=>B.playlist.length>0)),c=t((()=>0===B.duration?0:B.currentTime/B.duration*100)),u=e=>{e.addEventListener("play",(()=>{console.log("éŸ³é¢‘å¼€å§‹æ’­æ”¾"),B.isPlaying=!0,B.isPaused=!1,n("player_state_change",{isPlaying:!0,isPaused:!1})})),e.addEventListener("pause",(()=>{console.log("éŸ³é¢‘æš‚åœ"),B.isPlaying=!1,B.isPaused=!0,n("player_state_change",{isPlaying:!1,isPaused:!0})})),e.addEventListener("ended",(()=>{console.log("éŸ³é¢‘æ’­æ”¾ç»“æŸ"),B.isPlaying=!1,B.isPaused=!1,n("audio_ended")})),e.addEventListener("timeupdate",(()=>{void 0!==e.currentTime&&void 0!==e.duration&&(B.currentTime=e.currentTime,B.duration=e.duration,n("player_time_update",{currentTime:e.currentTime,duration:e.duration}))})),e.addEventListener("error",(e=>{const t=e.message||"æ’­æ”¾å¤±è´¥";console.error(`éŸ³é¢‘æ’­æ”¾é”™è¯¯: ${t}`),B.isPlaying=!1,B.isPaused=!1,B.hasErrorShown||(o({title:"æ’­æ”¾å¤±è´¥ï¼Œæ­£åœ¨å°è¯•ä¸‹ä¸€é¦–",icon:"none",duration:2e3}),B.hasErrorShown=!0,setTimeout((()=>{B.hasErrorShown=!1}),3e3)),B.playlist.length>1&&f()}))},d=async(t,s)=>{try{if(B.isLoadingAudio)return void console.log("éŸ³é¢‘æ­£åœ¨åŠ è½½ä¸­ï¼Œå¿½ç•¥é‡å¤è¯·æ±‚");if(B.isLoadingAudio=!0,B.hasErrorShown=!1,void 0!==s&&(B.currentIndex=s),t||(t=e.value),!t)throw new Error("æ²¡æœ‰å¯æ’­æ”¾çš„æ­Œæ›²");console.log("å¼€å§‹æ’­æ”¾:",t.name,"-",t.artist||"æœªçŸ¥è‰ºæœ¯å®¶");try{B.isPlaying&&F&&F.pause&&F.pause()}catch(l){console.warn("åœæ­¢å½“å‰éŸ³é¢‘å¤±è´¥:",l)}let o;try{o=_(t)}catch(a){throw console.error("è·å–éŸ³é¢‘URLå¤±è´¥:",a),new Error("è·å–éŸ³é¢‘URLå¤±è´¥")}if(!o||"string"!=typeof o)throw console.error("æ— æ•ˆçš„éŸ³é¢‘URL(ä¸ºç©ºæˆ–éå­—ç¬¦ä¸²)"),new Error("æ— æ³•è·å–æœ‰æ•ˆçš„éŸ³é¢‘URL");if(!o.startsWith("http"))throw console.error("æ— æ•ˆçš„éŸ³é¢‘URL(åè®®é”™è¯¯):",o.substring(0,30)),new Error("éŸ³é¢‘URLåè®®é”™è¯¯");F&&(F.src=o,F.autoplay=!0,F.load&&F.load(),F.play().catch((e=>{console.warn("éŸ³é¢‘è‡ªåŠ¨æ’­æ”¾è¢«æ‹¦æˆª:",e)}))),n("send_play_state",{action:"play",song:t,currentTime:0,timestamp:Date.now()}),setTimeout((()=>{B.isLoadingAudio=!1}),2e3)}catch(r){B.isLoadingAudio=!1,console.error("æ’­æ”¾éŸ³ä¹å¤±è´¥:",r),o({title:r.message||"æ’­æ”¾å¤±è´¥",icon:"none",duration:2e3})}},g=()=>{try{F&&F.pause(),n("send_play_state",{action:"pause",currentTime:B.currentTime,timestamp:Date.now()})}catch(e){console.error("æš‚åœæ’­æ”¾å¤±è´¥:",e)}},p=()=>{try{F&&F.play(),n("send_play_state",{action:"resume",currentTime:B.currentTime,timestamp:Date.now()})}catch(e){console.error("æ¢å¤æ’­æ”¾å¤±è´¥:",e)}},y=()=>{try{F&&(F.pause(),F.currentTime=0),B.currentTime=0,n("send_play_state",{action:"stop",timestamp:Date.now()})}catch(e){console.error("åœæ­¢æ’­æ”¾å¤±è´¥:",e)}},f=()=>{if(0===B.playlist.length)return;let e=v();B.currentIndex=e,d(B.playlist[e])},v=()=>{const e=B.playlist.length;if(0===e)return 0;switch(B.playMode){case"random":return Math.floor(Math.random()*e);case"loop":return B.currentIndex;default:return(B.currentIndex+1)%e}},h=e=>{switch(e){case"list":default:return"åˆ—è¡¨æ’­æ”¾";case"random":return"éšæœºæ’­æ”¾";case"loop":return"å•æ›²å¾ªç¯"}},_=e=>{if(e.url&&(e.url.startsWith("http://")||e.url.startsWith("https://")))return e.url;try{const t=s("serverConfig");if(!t)return console.error("æœªé…ç½®æœåŠ¡å™¨"),"";const o=m(t);if(!o)return console.error("æœåŠ¡å™¨é…ç½®æ ¼å¼é”™è¯¯"),"";const n=s("token");if(!n)return console.error("æœªç™»å½•ï¼Œæ— æ³•è·å–éŸ³é¢‘URL"),"";let l=e.filename||`${e.name}.${e.format||"mp3"}`;l.includes("/")&&(l=l.split("/").pop()),l.includes("\\")&&(l=l.split("\\").pop()),console.log("getAudioUrl: æ ‡å‡†åŒ–é…ç½® =",o),console.log("getAudioUrl: filename =",l,"song =",e);let a=o.fullUrl+"/api/music/storage/"+encodeURIComponent(l)+"?token="+encodeURIComponent(n);return console.log("æ„å»ºéŸ³é¢‘URL:",a),a}catch(t){return console.error("æ„å»ºéŸ³é¢‘URLå¤±è´¥:",t),""}},m=e=>{if(!e)return null;if(e.serverHost&&e.hasOwnProperty("useHttps"))return{host:e.serverHost,port:e.serverPort||"",protocol:e.useHttps?"https":"http",fullUrl:`${e.useHttps?"https":"http"}://${e.serverHost}${e.serverPort?":"+e.serverPort:""}`};if(e.url){let t=e.url,o="http",n="",s="";if(t.startsWith("https://")?(o="https",t=t.substring(8)):t.startsWith("http://")?(o="http",t=t.substring(7)):t.startsWith("wss://")?(o="https",t=t.substring(6)):t.startsWith("ws://")&&(o="http",t=t.substring(5)),t.includes("/")&&(t=t.split("/")[0]),t.includes(":")){const e=t.split(":");n=e[0],s=e[1]}else n=t,s=e.port||"";return{host:n,port:s,protocol:o,fullUrl:`${o}://${n}${s?":"+s:""}`}}return null};return{playerState:B,currentSong:e,hasPlaylist:i,progressPercent:c,initAudioManager:()=>{try{F||(F=new window.Audio,u(F),B.audioContext=F),console.log("éŸ³é¢‘ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ")}catch(e){console.error("éŸ³é¢‘ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:",e),o({title:"éŸ³é¢‘åˆå§‹åŒ–å¤±è´¥",icon:"error"})}},playMusic:d,pauseMusic:g,resumeMusic:p,stopMusic:y,togglePlay:()=>{B.isPlaying?g():B.isPaused?p():d()},playPrevious:()=>{if(0===B.playlist.length)return;let e=B.currentIndex-1;e<0&&(e=B.playlist.length-1),B.currentIndex=e,d(B.playlist[e])},playNext:f,setProgress:e=>{try{const t=e/100*B.duration;F&&(F.currentTime=t),B.currentTime=t}catch(t){console.error("è®¾ç½®æ’­æ”¾è¿›åº¦å¤±è´¥:",t)}},setVolume:e=>{try{B.volume=Math.max(0,Math.min(1,e)),F&&(F.volume=B.volume)}catch(t){console.error("è®¾ç½®éŸ³é‡å¤±è´¥:",t)}},setPlayMode:e=>{["list","random","loop"].includes(e)&&(B.playMode=e,o({title:h(e),icon:"none",duration:1500}))},getPlayModeText:h,addToPlaylist:e=>{e&&(B.playlist.some((t=>t.id===e.id))?o({title:"æ­Œæ›²å·²åœ¨æ’­æ”¾åˆ—è¡¨ä¸­",icon:"none"}):(B.playlist.push(e),o({title:"å·²æ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨",icon:"success"}),n("send_add_song",e)))},removeFromPlaylist:e=>{if(e<0||e>=B.playlist.length)return;const t=B.playlist[e];B.playlist.splice(e,1),e<B.currentIndex?B.currentIndex--:e===B.currentIndex&&(0===B.playlist.length?(y(),B.currentIndex=0):(B.currentIndex>=B.playlist.length&&(B.currentIndex=0),d(B.playlist[B.currentIndex]))),o({title:"å·²ä»æ’­æ”¾åˆ—è¡¨ç§»é™¤",icon:"success"}),n("send_remove_song",t.id)},clearPlaylist:()=>{y(),B.playlist=[],B.currentIndex=0,o({title:"æ’­æ”¾åˆ—è¡¨å·²æ¸…ç©º",icon:"success"})},formatTime:e=>{if(!e||isNaN(e))return"00:00";const t=Math.floor(e/60),o=Math.floor(e%60);return`${t.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`},destroy:()=>{try{F&&(F.destroy(),F=null),B.audioContext=null,B.backgroundAudioManager=null}catch(e){console.error("é”€æ¯éŸ³é¢‘ç®¡ç†å™¨å¤±è´¥:",e)}},debugServerConfig:()=>{try{const e=s("serverConfig");if(console.log("=== æœåŠ¡å™¨é…ç½®è°ƒè¯•ä¿¡æ¯ ==="),console.log("åŸå§‹é…ç½®:",JSON.stringify(e,null,2)),e){console.log("åŸå§‹é…ç½®å­—æ®µ:"),console.log("- serverHost:",e.serverHost),console.log("- serverPort:",e.serverPort),console.log("- useHttps:",e.useHttps),console.log("- url:",e.url),console.log("- port:",e.port);const t=m(e);console.log("æ ‡å‡†åŒ–åé…ç½®:",t);const o=_({name:"test",filename:"test.mp3"});console.log("æµ‹è¯•æ„å»ºçš„éŸ³é¢‘URL:",o),o.includes("mysxelfservice.gcsyweb.cbn")?(console.error("âŒ å‘ç°é—®é¢˜: URLä¸­åŒ…å«æ„å¤–çš„ä¸»æœºåœ°å€ mysxelfservice.gcsyweb.cbn"),console.error("è¿™å¯èƒ½æ˜¯ç¼“å­˜æˆ–é…ç½®é”™è¯¯å¯¼è‡´çš„"),l({title:"é…ç½®å¼‚å¸¸",content:"æ£€æµ‹åˆ°å¼‚å¸¸çš„æœåŠ¡å™¨åœ°å€ï¼Œè¯·é‡æ–°é…ç½®æœåŠ¡å™¨æˆ–æ¸…é™¤ç¼“å­˜",showCancel:!1})):o.includes("localhost")||o.includes("127.0.0.1")?console.log("âœ… ä½¿ç”¨æœ¬åœ°å¼€å‘æœåŠ¡å™¨"):console.log("âœ… URLæ„å»ºæ­£å¸¸ï¼Œä½¿ç”¨è¿œç¨‹æœåŠ¡å™¨")}console.log("=== è°ƒè¯•ä¿¡æ¯ç»“æŸ ===")}catch(e){console.error("è°ƒè¯•æœåŠ¡å™¨é…ç½®å¤±è´¥:",e)}},clearServerConfig:()=>{try{console.log("æ¸…ç†æœåŠ¡å™¨é…ç½®..."),a("serverConfig"),a("token"),a("userInfo"),l({title:"é…ç½®å·²æ¸…ç†",content:"æ‰€æœ‰æœåŠ¡å™¨é…ç½®å’Œç™»å½•ä¿¡æ¯å·²æ¸…é™¤ï¼Œè¯·é‡æ–°é…ç½®",showCancel:!1,success:()=>{r({url:"/pages/login/login"})}})}catch(e){console.error("æ¸…ç†é…ç½®å¤±è´¥:",e)}}}}(),{enabled:ce,enableBackgroundPlay:ue,disableBackgroundPlay:de}=function(){const e=async()=>{try{return console.log("ç¦ç”¨åå°æ’­æ”¾æ¨¡å¼"),s(),r(),w(),N.enabled=!1,o({title:"åå°æ’­æ”¾å·²ç¦ç”¨",icon:"success",duration:2e3}),{success:!0}}catch(e){return console.error("ç¦ç”¨åå°æ’­æ”¾å¤±è´¥:",e),{success:!1,error:e.message}}},t=async()=>{try{"wakeLock"in navigator?(N.wakeLock=await navigator.wakeLock.request("screen"),console.log("å±å¹•å”¤é†’é”è·å–æˆåŠŸ"),N.wakeLock.addEventListener("release",(()=>{console.log("å±å¹•å”¤é†’é”å·²é‡Šæ”¾")}))):console.warn("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ Wake Lock API")}catch(e){throw console.error("è¯·æ±‚å±å¹•å”¤é†’é”å¤±è´¥:",e),e}},s=()=>{try{N.wakeLock&&(N.wakeLock.release(),N.wakeLock=null),console.log("å±å¹•å”¤é†’é”å·²é‡Šæ”¾")}catch(e){console.error("é‡Šæ”¾å±å¹•å”¤é†’é”å¤±è´¥:",e)}},l=()=>{try{const e=window.AudioContext||window.webkitAudioContext;e&&(N.audioContext=new e,"suspended"===N.audioContext.state&&N.audioContext.resume(),console.log("éŸ³é¢‘ä¸Šä¸‹æ–‡åˆ›å»ºæˆåŠŸ"))}catch(e){console.error("åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡å¤±è´¥:",e)}},a=()=>{N.networkTimer&&clearInterval(N.networkTimer),N.networkTimer=setInterval((()=>{i({url:"data:text/plain,ping",method:"GET",timeout:3e3,success:()=>{},fail:e=>{console.warn("ç½‘ç»œä¿æ´»å¤±è´¥:",e)}})}),3e4),console.log("ç½‘ç»œä¿æ´»å·²å¯åŠ¨")},r=()=>{N.networkTimer&&(clearInterval(N.networkTimer),N.networkTimer=null,console.log("ç½‘ç»œä¿æ´»å·²åœæ­¢"))},d=()=>{document.addEventListener("visibilitychange",g),c((()=>{console.log("åº”ç”¨è¿›å…¥åå°"),N.isPageVisible=!1,p()})),u((()=>{console.log("åº”ç”¨å›åˆ°å‰å°"),N.isPageVisible=!0,y()}))},g=()=>{document.hidden?(console.log("é¡µé¢éšè—"),N.isPageVisible=!1,f()):(console.log("é¡µé¢æ˜¾ç¤º"),N.isPageVisible=!0,v())},p=()=>{N.enabled&&(h(),_(!0))},y=()=>{N.enabled&&(_(!1),N.wakeLock||t())},f=()=>{N.enabled&&h()},v=()=>{N.enabled&&N.audioContext&&"suspended"===N.audioContext.state&&N.audioContext.resume()},h=()=>{try{N.audioContext&&"suspended"===N.audioContext.state&&N.audioContext.resume()}catch(e){console.error("ç»´æŒéŸ³é¢‘æ’­æ”¾å¤±è´¥:",e)}},_=e=>{if(r(),N.enabled){const t=e?6e4:3e4;N.networkTimer=setInterval((()=>{i({url:"data:text/plain,ping",method:"GET",timeout:3e3,success:()=>{},fail:e=>{console.warn("ç½‘ç»œä¿æ´»å¤±è´¥:",e)}})}),t)}},m=()=>{N.keepAliveTimer&&clearInterval(N.keepAliveTimer),N.keepAliveTimer=setInterval((()=>{N.enabled&&n("send_heartbeat",{type:"background_heartbeat",timestamp:Date.now(),isPageVisible:N.isPageVisible})}),45e3),console.log("å¿ƒè·³ä¿æ´»å·²å¯åŠ¨")},w=()=>{N.keepAliveTimer&&(clearInterval(N.keepAliveTimer),N.keepAliveTimer=null,console.log("å¿ƒè·³ä¿æ´»å·²åœæ­¢"))};return{backgroundState:N,enableBackgroundPlay:async()=>{try{return console.log("å¯ç”¨åå°æ’­æ”¾æ¨¡å¼"),await t(),l(),a(),d(),m(),N.enabled=!0,o({title:"åå°æ’­æ”¾å·²å¯ç”¨",icon:"success",duration:2e3}),{success:!0}}catch(e){return console.error("å¯ç”¨åå°æ’­æ”¾å¤±è´¥:",e),o({title:"å¯ç”¨åå°æ’­æ”¾å¤±è´¥",icon:"error",duration:2e3}),{success:!1,error:e.message}}},disableBackgroundPlay:e,checkBackgroundSupport:()=>{const e={wakeLock:!1,audioContext:!1,backgroundAudio:!1};return e.wakeLock="wakeLock"in navigator,e.audioContext=!(!window.AudioContext&&!window.webkitAudioContext),e},getStatusInfo:()=>({enabled:N.enabled,wakeLockActive:!!N.wakeLock,audioContextState:N.audioContext?N.audioContext.state:"none",isPageVisible:N.isPageVisible,networkKeepAlive:!!N.networkTimer,heartbeatActive:!!N.keepAliveTimer}),destroy:()=>{e(),document.removeEventListener("visibilitychange",g),console.log("åå°æ’­æ”¾ç®¡ç†å™¨å·²é”€æ¯")}}}(),ge=d(!1),pe=e({playlist:[],currentIndex:0,isPlaying:!1,currentPosition:0}),ye=d(0);d(!1),d([]);const fe=d("è¿æ¥ä¸­...");d(!1);const ve=d("");console.log("ğŸ“Š [åˆå§‹åŒ–] åœ¨çº¿ç”¨æˆ·æ•°åˆå§‹å€¼:",ye.value);try{ve.value=z(),console.log("ğŸ” [æŒ‡çº¹] ç”¨æˆ·æŒ‡çº¹:",ve.value),tt()}catch(ot){console.error("è·å–ç”¨æˆ·æŒ‡çº¹å¤±è´¥:",ot),ve.value="unknown"}const he=d({isActive:!1,hasWakeLock:!1,audioContextState:"none",networkKeepAlive:!1,heartbeat:!1}),_e=t((()=>pe.playlist||[])),me=t((()=>pe.currentIndex||0)),we=t((()=>pe.isPlaying||!1)),ke=t((()=>_e.value[me.value]||null)),Pe=t((()=>0===q.duration?0:q.currentTime/q.duration*100)),xe=t((()=>q.currentTime||0)),be=t((()=>q.duration||0)),Ce=e=>{if(!e||isNaN(e))return"00:00";const t=Math.floor(e/60),o=Math.floor(e%60);return`${t.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`};g((async()=>{console.log("éŸ³ä¹æ’­æ”¾å™¨é¡µé¢æŒ‚è½½å¼€å§‹"),console.log("ğŸ“Š [åˆå§‹åŒ–] å½“å‰åœ¨çº¿ç”¨æˆ·æ•°:",ye.value);try{await Ie(),console.log("æ’­æ”¾å™¨åˆå§‹åŒ–å®Œæˆï¼Œå¼€å§‹åŠ è½½æ’­æ”¾åˆ—è¡¨"),await Te(),console.log("æ’­æ”¾åˆ—è¡¨åŠ è½½å®Œæˆ"),Ae(),console.log("äº‹ä»¶ç›‘å¬å™¨è®¾ç½®å®Œæˆ"),p("audio_ended",Re),console.log("éŸ³é¢‘ç»“æŸäº‹ä»¶ç›‘å¬å·²è®¾ç½®"),console.log("éŸ³ä¹æ’­æ”¾å™¨åˆå§‹åŒ–å…¨éƒ¨å®Œæˆ"),console.log("ğŸ“Š [åˆå§‹åŒ–å®Œæˆ] æœ€ç»ˆåœ¨çº¿ç”¨æˆ·æ•°:",ye.value)}catch(ot){console.error("éŸ³ä¹æ’­æ”¾å™¨åˆå§‹åŒ–å¤±è´¥:",ot)}})),y((()=>{Le()}));const Ie=async()=>{try{console.log("å¼€å§‹åˆå§‹åŒ–æ’­æ”¾å™¨..."),re(),Q(),console.log("éŸ³é¢‘ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ"),await ue(),he.value.isActive=!0,console.log("åå°æ’­æ”¾å¯ç”¨å®Œæˆ");const e=s("serverConfig");if(console.log("è·å–æœåŠ¡å™¨é…ç½®:",e),e){let t="";if(e.serverHost&&e.hasOwnProperty("useHttps")){const o=e.useHttps?"https":"http",n=e.serverHost;t=`${o}://${n}${e.serverPort?`:${e.serverPort}`:""}`}else if(e.url&&(t=e.url,t.includes("/api")||t.includes("/ws"))){const e=t.split("/");t=`${e[0]}//${e[2]}`}t?(console.log("ä½¿ç”¨æœåŠ¡å™¨URLè¿æ¥:",t),await X(t),fe.value="å·²è¿æ¥",console.log("æœåŠ¡å™¨è¿æ¥å®Œæˆ")):(fe.value="æœåŠ¡å™¨é…ç½®æ— æ•ˆ",console.error("æ— æ³•æ„å»ºæœ‰æ•ˆçš„æœåŠ¡å™¨URL"))}else fe.value="æœªé…ç½®æœåŠ¡å™¨",console.warn("æœªæ‰¾åˆ°æœåŠ¡å™¨é…ç½®")}catch(ot){console.error("åˆå§‹åŒ–æ’­æ”¾å™¨å¤±è´¥:",ot),fe.value="è¿æ¥å¤±è´¥"}},Te=async()=>{try{console.log("å¼€å§‹åŠ è½½æ’­æ”¾åˆ—è¡¨...");const e=await K();console.log("æ’­æ”¾åˆ—è¡¨æ•°æ®:",e),e&&e.playlist?(pe.playlist=e.playlist,pe.currentIndex=e.current_index||0,pe.isPlaying=e.is_playing||!1,pe.currentPosition=e.current_position||0,console.log("æ’­æ”¾åˆ—è¡¨åŠ è½½æˆåŠŸï¼Œæ­Œæ›²æ•°é‡:",e.playlist.length)):console.warn("æ’­æ”¾åˆ—è¡¨æ•°æ®æ ¼å¼ä¸æ­£ç¡®:",e)}catch(ot){console.error("åŠ è½½æ’­æ”¾åˆ—è¡¨å¤±è´¥:",ot)}},Ae=()=>{p("play_state_change",Ne),p("playlist_update",De),p("poll_state_update",Oe),p("poll_clients_update",Ze),p("player_state_change",Ye),p("player_time_update",et)},Le=()=>{f("play_state_change",Ne),f("playlist_update",De),f("poll_state_update",Oe),f("poll_clients_update",Ze),f("player_state_change",Ye),f("player_time_update",et),f("audio_ended",Re),We(),G()},Se=async()=>{if(ke.value)try{we.value?(await ee(),pe.isPlaying=!1,q.isPlaying=!1,We()):(q.isPaused?await te():await Y(ke.value),pe.isPlaying=!0,q.isPlaying=!0,Ve()),Be()}catch(ot){console.error("æ’­æ”¾æ§åˆ¶å¤±è´¥:",ot),o({title:"æ’­æ”¾å¤±è´¥",icon:"none"})}},$e=async()=>{if(0===_e.value.length)return;const e=me.value>0?me.value-1:_e.value.length-1;await Ee(e)},Me=async()=>{if(0===_e.value.length)return;const e=me.value<_e.value.length-1?me.value+1:0;await Ee(e)},Ee=async e=>{if(!(e<0||e>=_e.value.length))try{pe.isPlaying&&await oe(),pe.currentIndex=e,await Y(_e.value[e]),pe.isPlaying=!0,q.isPlaying=!0,Ve(),await Fe(e),Be()}catch(ot){console.error("æ’­æ”¾æ­Œæ›²å¤±è´¥:",ot),o({title:"æ’­æ”¾å¤±è´¥",icon:"none"})}},Ue=()=>{if(_e.value.length<=1)return;const e=Math.floor(Math.random()*_e.value.length);Ee(e)},He=async e=>{var t;const o=Z();if(!o||!o.token)throw new Error("æœªç™»å½•");const n=J.serverUrl||(null==(t=s("serverConfig"))?void 0:t.url);if(!n)throw new Error("æœåŠ¡å™¨åœ°å€æœªé…ç½®");return console.log("å‘æœåŠ¡å™¨å‘é€åˆ é™¤è¯·æ±‚ï¼Œç´¢å¼•:",e),console.log("æœåŠ¡å™¨åœ°å€:",n),new Promise(((t,s)=>{const l=V();if(!/^[a-zA-Z0-9_-]+$/.test(l))return console.error("æŒ‡çº¹åŒ…å«éASCIIå­—ç¬¦:",l),void s(new Error("Fingerprint contains non-ASCII characters"));i({url:`${n}/api/delete/${e}`,method:"DELETE",header:{Authorization:`Bearer ${o.token}`,"Content-Type":"application/json","X-User-Fingerprint":l},success:e=>{console.log("åˆ é™¤å“åº”:",e),200===e.statusCode?(console.log("åˆ é™¤æˆåŠŸ:",e.data),t(e.data)):(console.error("åˆ é™¤å¤±è´¥ï¼ŒçŠ¶æ€ç :",e.statusCode,"å“åº”:",e.data),s(new Error(`åˆ é™¤å¤±è´¥: HTTP ${e.statusCode}`)))},fail:e=>{console.error("åˆ é™¤è¯·æ±‚å¤±è´¥:",e),s(e)}})}))},Re=async()=>{if(console.log("å½“å‰æ­Œæ›²æ’­æ”¾ç»“æŸï¼Œå‡†å¤‡æ’­æ”¾ä¸‹ä¸€é¦–"),pe.isPlaying=!1,q.isPlaying=!1,!_e.value||_e.value.length<=1)console.log("æ’­æ”¾åˆ—è¡¨ä¸ºç©ºæˆ–åªæœ‰ä¸€é¦–æ­Œï¼Œä¸æ‰§è¡Œè‡ªåŠ¨æ’­æ”¾ä¸‹ä¸€é¦–");else try{setTimeout((async()=>{await Me(),console.log("å·²è‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€é¦–æ­Œæ›²")}),300)}catch(ot){console.error("è‡ªåŠ¨åˆ‡æ¢ä¸‹ä¸€é¦–æ­Œæ›²å¤±è´¥:",ot)}},je=e=>{try{const t=e.detail.value||0;console.log("æ‹–åŠ¨è¿›åº¦æ¡åˆ°:",t+"%"),ae(t),Be()}catch(ot){console.error("è®¾ç½®æ’­æ”¾è¿›åº¦å¤±è´¥:",ot)}};let ze=null;const Ve=()=>{ze&&clearInterval(ze),ze=setInterval((()=>{pe.isPlaying&&q.currentTime>0&&Be()}),5e3)},We=()=>{ze&&(clearInterval(ze),ze=null)},Be=async()=>{var e;try{const t=Z();if(!t||!t.token)return void console.warn("æœªç™»å½•ï¼Œæ— æ³•åŒæ­¥çŠ¶æ€");const o=J.serverUrl||(null==(e=s("serverConfig"))?void 0:e.url);if(!o)return void console.warn("æœåŠ¡å™¨åœ°å€æœªé…ç½®ï¼Œæ— æ³•åŒæ­¥çŠ¶æ€");const n={current_index:pe.currentIndex,is_playing:pe.isPlaying,current_position:q.currentTime||0};if(J.websocketConnected&&"function"==typeof J.sendMessage)J.sendMessage({type:"sync_state",data:n});else{const e=V();if(!/^[a-zA-Z0-9_-]+$/.test(e))return void console.error("æŒ‡çº¹åŒ…å«éASCIIå­—ç¬¦:",e);i({url:`${o}/api/poll/update-play-state`,method:"POST",header:{Authorization:`Bearer ${t.token}`,"Content-Type":"application/json","X-User-Fingerprint":e},data:{is_playing:pe.isPlaying,position:q.currentTime||0},success:e=>{200===e.statusCode?console.log("æ’­æ”¾çŠ¶æ€åŒæ­¥æˆåŠŸ"):console.warn("æ’­æ”¾çŠ¶æ€åŒæ­¥å¤±è´¥:",e.statusCode)},fail:e=>{console.error("æ’­æ”¾çŠ¶æ€åŒæ­¥è¯·æ±‚å¤±è´¥:",e)}})}}catch(ot){console.error("çŠ¶æ€åŒæ­¥å¤±è´¥:",ot)}},Fe=async e=>{var t;try{const o=Z();if(!o||!o.token)return void console.warn("æœªç™»å½•ï¼Œæ— æ³•åŒæ­¥æ­Œæ›²åˆ‡æ¢");const n=J.serverUrl||(null==(t=s("serverConfig"))?void 0:t.url);if(!n)return void console.warn("æœåŠ¡å™¨åœ°å€æœªé…ç½®ï¼Œæ— æ³•åŒæ­¥æ­Œæ›²åˆ‡æ¢");if(console.log("åŒæ­¥æ­Œæ›²åˆ‡æ¢åˆ°æœåŠ¡å™¨:",e),J.websocketConnected&&"function"==typeof J.sendMessage)J.sendMessage({type:"change_song",data:{index:e}});else{const t=V();if(!/^[a-zA-Z0-9_-]+$/.test(t))return void console.error("æŒ‡çº¹åŒ…å«éASCIIå­—ç¬¦:",t);i({url:`${n}/api/poll/change-song`,method:"POST",header:{Authorization:`Bearer ${o.token}`,"Content-Type":"application/json","X-User-Fingerprint":t},data:{index:e},success:e=>{200===e.statusCode?console.log("æ­Œæ›²åˆ‡æ¢åŒæ­¥æˆåŠŸ"):console.warn("æ­Œæ›²åˆ‡æ¢åŒæ­¥å¤±è´¥:",e.statusCode)},fail:e=>{console.error("æ­Œæ›²åˆ‡æ¢åŒæ­¥è¯·æ±‚å¤±è´¥:",e)}})}}catch(ot){console.error("æ­Œæ›²åˆ‡æ¢åŒæ­¥å¤±è´¥:",ot)}},Ne=e=>{console.log("æ”¶åˆ°æ’­æ”¾çŠ¶æ€å˜åŒ–:",e),e&&"object"==typeof e&&(void 0!==e.is_playing&&(pe.isPlaying=e.is_playing),void 0!==e.current_index&&(pe.currentIndex=e.current_index),void 0!==e.current_position&&Math.abs(e.current_position-(q.currentTime||0))>10&&(q.currentTime=e.current_position),void 0!==e.connected_clients&&(console.log("ğŸ“Š [WebSocket] æ›´æ–°åœ¨çº¿ç”¨æˆ·æ•°:",e.connected_clients,"(æ¥æº: WebSocketçŠ¶æ€æ›´æ–°)"),ye.value=e.connected_clients))},De=e=>{console.log("æ”¶åˆ°æ’­æ”¾åˆ—è¡¨æ›´æ–°:",e),e&&e.playlist&&Array.isArray(e.playlist)?(pe.playlist=e.playlist,void 0!==e.current_index&&(pe.currentIndex=e.current_index),void 0!==e.is_playing&&(pe.isPlaying=e.is_playing),void 0!==e.connected_clients&&(console.log("ğŸ“Š [æ’­æ”¾åˆ—è¡¨] æ›´æ–°åœ¨çº¿ç”¨æˆ·æ•°:",e.connected_clients,"(æ¥æº: æ’­æ”¾åˆ—è¡¨æ›´æ–°)"),ye.value=e.connected_clients)):Te()},Oe=async e=>{e&&"object"==typeof e&&(JSON.stringify(pe.playlist)!==JSON.stringify(e.playlist)&&(console.log("æ”¶åˆ°æ’­æ”¾åˆ—è¡¨æ›´æ–°:",e.playlist),e.playlist&&Array.isArray(e.playlist)&&(pe.playlist=e.playlist)),void 0!==e.is_playing&&e.is_playing!==pe.isPlaying&&(console.log("æ”¶åˆ°æ’­æ”¾çŠ¶æ€æ›´æ–°:",e.is_playing),await Se()),void 0!==e.current_index&&pe.currentIndex!==e.current_index&&(console.log("æ”¶åˆ°å½“å‰ç´¢å¼•æ›´æ–°:",e.current_index),pe.currentIndex=e.current_index,await Y(_e.value[pe.currentIndex]),pe.isPlaying=!0,pe.isPaused=!1,q.isPlaying=!0,q.isPaused=!1),e.current_position,void 0!==e.connected_clients&&(ye.value=e.connected_clients))},Ze=e=>{e&&void 0!==e.connected_clients&&(ye.value=e.connected_clients)},Je=()=>{ge.value=!0},Xe=()=>{ge.value=!1},Ge=()=>{const e=document.createElement("input");e.type="file",e.accept=".mp3,.wav,.flac,.m4a",e.onchange=Ke,e.click()},Ke=async e=>{console.log("é€‰æ‹©çš„æ–‡ä»¶:",e);let t=null;if(e.target&&e.target.files&&e.target.files[0]&&(t=e.target.files[0],console.log("H5é€‰æ‹©çš„æ–‡ä»¶:",t)),!t)return console.error("æœªæ‰¾åˆ°æœ‰æ•ˆæ–‡ä»¶"),void o({title:"æœªé€‰æ‹©æœ‰æ•ˆæ–‡ä»¶",icon:"error"});try{Xe(),T({title:"ä¸Šä¼ ä¸­..."}),await qe(t),await K(),A(),o({title:"ä¸Šä¼ æˆåŠŸ",icon:"success"}),setTimeout((()=>{Xe()}),1500)}catch(ot){console.error("ä¸Šä¼ å¤±è´¥:",ot),A(),l({title:"ä¸Šä¼ å¤±è´¥",content:`ä¸Šä¼ å¤±è´¥: ${ot.message||"æœªçŸ¥é”™è¯¯"}\n\næ˜¯å¦é‡æ–°é€‰æ‹©æ–‡ä»¶ï¼Ÿ`,confirmText:"é‡æ–°é€‰æ‹©",cancelText:"å…³é—­",success:e=>{e.confirm||Xe()}})}},qe=async e=>{var t;const o=Z();if(!o||!o.token)throw new Error("æœªç™»å½•");const n=J.serverUrl||(null==(t=s("serverConfig"))?void 0:t.url);if(!n)throw new Error("æœåŠ¡å™¨åœ°å€æœªé…ç½®");console.log("å¼€å§‹ä¸Šä¼ æ–‡ä»¶:",e.name||e.fileName,"å¤§å°:",e.size),console.log("æœåŠ¡å™¨åœ°å€:",n);const l=new FormData;l.append("file",e);const a=V();if(!/^[a-zA-Z0-9_-]+$/.test(a))throw console.error("æŒ‡çº¹åŒ…å«éASCIIå­—ç¬¦:",a),new Error("Fingerprint contains non-ASCII characters");const r=await fetch(`${n}/api/upload`,{method:"POST",headers:{Authorization:`Bearer ${o.token}`,"X-User-Fingerprint":a},body:l});if(!r.ok)throw new Error(`ä¸Šä¼ å¤±è´¥: HTTP ${r.status}`);const i=await r.json();return console.log("ä¸Šä¼ æˆåŠŸ:",i),i},Qe=async()=>{try{l({title:"ç¡®è®¤é€€å‡º",content:"ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ",success:async e=>{e.confirm&&(await D(),pe.isPlaying&&await oe(),G(),L({url:"/pages/userLogin/userLogin"}))}})}catch(ot){console.error("é€€å‡ºç™»å½•å¤±è´¥:",ot)}},Ye=e=>{console.log("æ”¶åˆ°éŸ³é¢‘æ§åˆ¶å™¨çŠ¶æ€å˜åŒ–:",e),e&&"object"==typeof e&&(void 0!==e.isPlaying&&(pe.isPlaying=e.isPlaying,q.isPlaying=e.isPlaying),void 0!==e.isPaused&&(q.isPaused=e.isPaused))},et=e=>{e&&"object"==typeof e&&(void 0!==e.currentTime&&(q.currentTime=e.currentTime),void 0!==e.duration&&(q.duration=e.duration))},tt=()=>{try{const e=V();console.log("=== æŒ‡çº¹å®‰å…¨æ€§æµ‹è¯• ==="),console.log("ç”Ÿæˆçš„æŒ‡çº¹:",e),console.log("æŒ‡çº¹é•¿åº¦:",e.length);const t=/^[a-zA-Z0-9_-]+$/.test(e);console.log("ASCIIå®‰å…¨æ€§:",t?"âœ… é€šè¿‡":"âŒ å¤±è´¥");let o=!1;for(let n=0;n<e.length;n++){const t=e.charCodeAt(n);t>127&&(console.log(`âŒ å‘ç°éASCIIå­—ç¬¦: "${e[n]}" (ç ç‚¹: ${t}) ä½ç½®: ${n}`),o=!0)}return o||console.log("âœ… æ‰€æœ‰å­—ç¬¦éƒ½åœ¨ASCIIèŒƒå›´å†…"),console.log("=== æµ‹è¯•ç»“æŸ ==="),t&&!o}catch(ot){return console.error("æŒ‡çº¹å®‰å…¨æ€§æµ‹è¯•å¤±è´¥:",ot),!1}};return(e,t)=>{const n=S,s=_,a=$,r=M,i=E;return m(),v(s,{class:"music-player"},{default:h((()=>[w(s,{class:"header"},{default:h((()=>[w(s,{class:"header-content"},{default:h((()=>[w(n,{class:"header-title"},{default:h((()=>[k("éŸ³ä¹ä¸€èµ·å¬")])),_:1}),w(s,{class:"header-actions"},{default:h((()=>[w(s,{class:"online-badge"},{default:h((()=>[w(n,{class:"user-icon"},{default:h((()=>[k("ğŸ‘¥")])),_:1}),w(n,{class:"user-count"},{default:h((()=>[k(P(ye.value),1)])),_:1}),w(n,{class:"badge-text"},{default:h((()=>[k("åœ¨çº¿ç”¨æˆ·")])),_:1})])),_:1}),w(a,{class:"logout-btn",onClick:Qe},{default:h((()=>[w(n,{class:"btn-icon"},{default:h((()=>[k("ğŸšª")])),_:1}),w(n,{class:"btn-text"},{default:h((()=>[k("é€€å‡ºç™»å½•")])),_:1})])),_:1})])),_:1})])),_:1})])),_:1}),w(s,{class:"player-section"},{default:h((()=>[w(s,{class:"player-card"},{default:h((()=>[w(s,{class:"current-song"},{default:h((()=>[w(n,{class:"song-title"},{default:h((()=>[k(P(ke.value?ke.value.name:"æš‚æ— æ’­æ”¾"),1)])),_:1}),w(s,{class:"status-info"},{default:h((()=>[w(n,{class:"connection-status"},{default:h((()=>[k(P(fe.value),1)])),_:1}),w(n,{class:"user-fingerprint"},{default:h((()=>[k("æŒ‡çº¹: "+P(ve.value),1)])),_:1})])),_:1})])),_:1}),w(s,{class:"progress-section"},{default:h((()=>[w(n,{class:"time"},{default:h((()=>[k(P(Ce(xe.value)),1)])),_:1}),w(r,{class:"progress-slider",value:Pe.value,max:100,"block-size":"20",backgroundColor:"#e9ecef",activeColor:"#667eea",onChange:je},null,8,["value"]),w(n,{class:"time"},{default:h((()=>[k(P(Ce(be.value)),1)])),_:1})])),_:1}),w(s,{class:"controls"},{default:h((()=>[w(a,{class:"control-btn",onClick:$e,disabled:!_e.value.length},{default:h((()=>[w(n,{class:"control-icon"},{default:h((()=>[k("â®")])),_:1})])),_:1},8,["disabled"]),w(a,{class:"play-btn",onClick:Se,disabled:!ke.value},{default:h((()=>[w(n,{class:"play-icon"},{default:h((()=>[k(P(we.value?"â¸":"â–¶ï¸"),1)])),_:1})])),_:1},8,["disabled"]),w(a,{class:"control-btn",onClick:Me,disabled:!_e.value.length},{default:h((()=>[w(n,{class:"control-icon"},{default:h((()=>[k("â­")])),_:1})])),_:1},8,["disabled"]),w(a,{class:"shuffle-btn",onClick:Ue,disabled:!_e.value.length},{default:h((()=>[w(n,{class:"shuffle-icon"},{default:h((()=>[k("ğŸ”€")])),_:1}),w(n,{class:"shuffle-text"},{default:h((()=>[k("éšæœº")])),_:1})])),_:1},8,["disabled"])])),_:1})])),_:1})])),_:1}),w(s,{class:"playlist-section"},{default:h((()=>[w(s,{class:"playlist-header"},{default:h((()=>[w(n,{class:"playlist-title"},{default:h((()=>[k("æ’­æ”¾åˆ—è¡¨ ("+P(_e.value.length)+"é¦–)",1)])),_:1}),w(s,{class:"playlist-actions"},{default:h((()=>[w(a,{class:"upload-btn",onClick:Je},{default:h((()=>[w(n,{class:"upload-icon"},{default:h((()=>[k("â¬†ï¸")])),_:1}),w(n,{class:"upload-text"},{default:h((()=>[k("ä¸Šä¼ éŸ³ä¹")])),_:1})])),_:1})])),_:1})])),_:1}),w(s,{class:"playlist-content"},{default:h((()=>[_e.value.length?(m(),v(i,{key:1,class:"song-list","scroll-y":""},{default:h((()=>[(m(!0),x(C,null,b(_e.value,((e,t)=>(m(),v(s,{key:t,class:U(["song-item",{active:t===me.value}]),onClick:e=>Ee(t)},{default:h((()=>[w(s,{class:"song-info"},{default:h((()=>[w(n,{class:"song-index"},{default:h((()=>[k(P(t+1),1)])),_:2},1024),w(s,{class:"song-details"},{default:h((()=>[w(n,{class:"song-name"},{default:h((()=>[k(P(e.name),1)])),_:2},1024),w(n,{class:"song-format"},{default:h((()=>{var t;return[k(P((null==(t=e.format)?void 0:t.toUpperCase())||"MP3"),1)]})),_:2},1024)])),_:2},1024)])),_:2},1024),w(s,{class:"song-actions"},{default:h((()=>[t===me.value&&we.value?(m(),v(a,{key:0,class:"playing-indicator"},{default:h((()=>[w(n,{class:"playing-icon"},{default:h((()=>[k("ğŸµ")])),_:1})])),_:1})):I("",!0),w(a,{class:"delete-btn",onClick:H((e=>(async e=>{if(e<0||e>=_e.value.length)return void console.error("æ— æ•ˆçš„æ­Œæ›²ç´¢å¼•:",e);const t=_e.value[e];console.log("å‡†å¤‡åˆ é™¤æ­Œæ›²:",t.name,"ç´¢å¼•:",e);try{l({title:"ç¡®è®¤åˆ é™¤",content:`ç¡®å®šè¦åˆ é™¤ "${t.name}" å—ï¼Ÿ`,success:async t=>{if(t.confirm)try{T({title:"åˆ é™¤ä¸­..."}),await He(e);const t=[...pe.playlist];t.splice(e,1),pe.playlist=t,e===pe.currentIndex?(pe.currentIndex>=t.length&&t.length>0&&(pe.currentIndex=t.length-1),0===t.length&&(pe.currentIndex=0,pe.isPlaying=!1,await oe())):e<pe.currentIndex&&(pe.currentIndex=pe.currentIndex-1),setTimeout((()=>{K()}),1e3),A(),o({title:"åˆ é™¤æˆåŠŸ",icon:"success"})}catch(ot){console.error("åˆ é™¤æ­Œæ›²å¤±è´¥:",ot),A(),o({title:"åˆ é™¤å¤±è´¥: "+(ot.message||"æœªçŸ¥é”™è¯¯"),icon:"error"})}}})}catch(ot){console.error("åˆ é™¤æ­Œæ›²å¤±è´¥:",ot)}})(t)),["stop"])},{default:h((()=>[w(n,{class:"delete-icon"},{default:h((()=>[k("ğŸ—‘")])),_:1})])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1032,["class","onClick"])))),128))])),_:1})):(m(),v(s,{key:0,class:"empty-playlist"},{default:h((()=>[w(n,{class:"empty-icon"},{default:h((()=>[k("ğŸµ")])),_:1}),w(n,{class:"empty-text"},{default:h((()=>[k("æš‚æ— éŸ³ä¹æ–‡ä»¶")])),_:1}),w(n,{class:"empty-tip"},{default:h((()=>[k("è¯·ä¸Šä¼ éŸ³ä¹æ–‡ä»¶å¼€å§‹æ’­æ”¾")])),_:1})])),_:1}))])),_:1})])),_:1}),ge.value?(m(),v(s,{key:0,class:"upload-dialog"},{default:h((()=>[w(s,{class:"dialog-mask",onClick:Xe}),w(s,{class:"dialog-content"},{default:h((()=>[w(s,{class:"dialog-header"},{default:h((()=>[w(n,{class:"dialog-title"},{default:h((()=>[k("ä¸Šä¼ éŸ³ä¹")])),_:1}),w(a,{class:"dialog-close",onClick:Xe},{default:h((()=>[w(n,null,{default:h((()=>[k("âœ•")])),_:1})])),_:1})])),_:1}),w(s,{class:"dialog-body"},{default:h((()=>[w(n,{class:"upload-tips"},{default:h((()=>[k("è¯·é€‰æ‹©éŸ³ä¹æ–‡ä»¶ (æ”¯æŒ MP3, WAV, FLAC, M4A)")])),_:1}),w(a,{class:"file-select-btn",onClick:Ge},{default:h((()=>[w(n,{class:"select-icon"},{default:h((()=>[k("ğŸ“")])),_:1}),w(n,{class:"select-text"},{default:h((()=>[k("é€‰æ‹©æ–‡ä»¶")])),_:1})])),_:1})])),_:1})])),_:1})])),_:1})):I("",!0)])),_:1})}}},[["__scopeId","data-v-9d036609"]]);export{D as default};
